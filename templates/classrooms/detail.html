{% extends "base.html" %}
{% load attr_extras %}
{% block title %}{{ room.building }} {{ room.room_number }}{% endblock %}

{% block head_extra %}

<link rel="stylesheet" href="https://unpkg.com/pannellum@2.5.6/build/pannellum.css">
<style>
  .chip {display:inline-flex; align-items:center; gap:.4rem; border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; background:#fff;}
  .chip i {opacity:.75;}
  .feature-accordion .accordion-button{font-weight:600;}
  .kv-row{display:flex; justify-content:space-between; gap:.75rem; padding:.4rem .25rem; border-bottom:1px dashed #eee;}
  .kv-row .k{color:#6c757d; min-width:48%; }
  .kv-row .v{font-weight:500;}
  .sidebar-thumbs { position: sticky; top: 80px; display:flex; flex-direction:column; gap:1rem; }
  .sidebar-thumbs img{ width:100%; height:110px; object-fit:cover; border-radius:6px; border:1px solid #ddd; cursor:pointer; }
  .sidebar-thumbs img.active{ outline:3px solid #0d6efd }
  #pano-wrap{ position:relative; width:100%; border:1px solid #ddd; border-radius:8px; overflow:hidden; aspect-ratio:3/1; min-height:320px; }
  #pano{ position:absolute; inset:0; }

  #photoLightbox .modal-content { background: transparent; border: 0; box-shadow: none; }
  #lightboxCaption { border-top: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.55); }

  #pano{ position:absolute; inset:0; }
  /* Dialog: fill most of viewport, no borders/shadows */
  #photoLightbox .modal-dialog { max-width: min(96vw, 1400px); margin: 0 auto; }
  #photoLightbox .modal-content { background: transparent; border: 0; box-shadow: none; }
  #photoLightbox .modal-body   { padding: 0; background: transparent; }

  /* Stage fills the viewport height; image fits both axes without borders */
  #lightboxStage{
    height: min(86vh, 100vh - 80px);   /* room for close + caption */
    width: 100%;
    display: flex; align-items: center; justify-content: center;
    background: transparent;
    
    
  }
  #lightboxImg{
    max-width: 100%;
    max-height: 100%;
    width: auto; height: auto;
    display: block;
    border: 0; background: transparent; /* kill the black frame */
  }

  /* Caption overlay: only a thin top border */
  #lightboxCaption{
    position: absolute; left: 0; right: 0; bottom: 0;
    padding: 10px 12px;
    background: rgba(0,0,0,.55);
    color: rgba(255,255,255,.9);
    border-top: 1px solid rgba(255,255,255,.18); /* the ONLY border */
  }

  /* Prev/Next arrows floating over the image */
  #photoLightbox .lb-nav{
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 40px; height: 40px; border-radius: 999px;
    border: 0; box-shadow: none;
    background: rgba(0,0,0,.35); color: #fff;
  }
  #prevPhoto{ left: 10px; }
  #nextPhoto{ right: 10px; }

    
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="h4 text-center mb-3">{{ room.building }} {{ room.room_number }}</h1>

  <div class="row g-3">
<aside class="col-12 col-lg-3 order-2 order-lg-1">
  <div class="sidebar-thumbs">
    {% if photos %}
      {% for ph in photos %}
        {% if ph.image_file %}
          <a href="{{ ph.image_file.url }}" target="_blank" rel="noopener">
            <img
              src="{{ ph.image_file.url }}"
              alt="{{ ph.caption|default:'Classroom photo' }}"
              loading="lazy" decoding="async">
          </a>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="text-muted small">No photos uploaded yet.</div>
    {% endif %}
  </div>
</aside>


    <section class="col-12 col-lg-9 order-1 order-lg-2">
      <div id="pano-wrap" role="region" aria-label="360-degree view of {{ room.building }} {{ room.room_number }}">
        <div id="pano"></div>
      </div>
      <!-- Highlights -->
      {% if highlights %}
      <div class="d-flex flex-wrap gap-2 my-3">
        {% for h in highlights %}
          <span class="chip"><i class="bi bi-stars"></i>{{ h }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Key facts -->
      <div class="row g-3 mb-2">
        <div class="col-12 col-md-6">
          <div class="p-3 border rounded-3 h-100">
            <div class="kv-row"><div class="k">Location</div><div class="v">{{ room.building.name }}</div></div>
            <div class="kv-row"><div class="k">Campus</div><div class="v">{{ room.building.get_campus_display }}</div></div>
            <div class="kv-row"><div class="k">Capacity</div><div class="v">{{ room.capacity }}</div></div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="p-3 border rounded-3 h-100">
            <div class="kv-row"><div class="k">Wireless</div><div class="v">{{ room.get_wireless_presentation_display|default:"None" }}</div></div>
            <div class="kv-row"><div class="k">Instructor PC</div><div class="v">{{ room.instructor_pc_equipped|yesno:"Yes,No" }}</div></div>
            <div class="kv-row"><div class="k">Recording</div><div class="v">{{ room.class_capture|yesno:"Yes,No" }}</div></div>
          </div>
        </div>
      </div>

      <!-- Grouped features -->
      <div class="accordion feature-accordion mb-3" id="featAcc">
        {% for group, fields in feature_groups.items %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#acc{{ forloop.counter }}">

              {{ group }}
            </button>
          </h2>
          <div id="acc{{ forloop.counter }}" class="accordion-collapse collapse show">

            <div class="accordion-body">
              <div class="row row-cols-1 row-cols-sm-2 g-2">
                {% for f in fields %}
                  {% field_type room f as ftype %}
                  <div class="col">
                    <div class="border rounded-3 p-2 h-100">
                      <div class="small text-muted">{% field_verbose room f %}</div>
                      <div class="fw-semibold mt-1">
                        {% if f == "wireless_presentation" %}
                          {{ room.get_wireless_presentation_display|default:"None" }}
                        {% elif ftype == "BooleanField" %}
                          {{ room|attr:f|yesno:"Yes,No" }}
                        {% else %}
                          {{ room|attr:f }}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
            {% if room.book_url %}
              <a class="btn btn-primary" href="{{ room.book_url }}" target="_blank" rel="noopener">
                Book this class
              </a>
            {% endif %}
            {% if room.building.tech_contact_name or room.building.tech_contact or room.building.tech_contact_email %}
              <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#techModal">
                Tech support
              </button>
            {% endif %}
            {% if room.building.more_info_url %}
              <a class="btn btn-outline-dark" href="{{ room.building.more_info_url }}" target="_blank" rel="noopener">
                More info
              </a>
            {% endif %}
          </div>
       
   <!-- Photo Lightbox -->
        <div class="modal fade" id="photoLightbox" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
              <div class="modal-body p-0 position-relative">
                <button type="button"
                        class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>

                <!-- Full-height stage; image centers and scales to fit -->
                <div id="lightboxStage">
                  <img id="lightboxImg" alt="">
                </div>

                <!-- Caption overlay with only a top border -->
                <div id="lightboxCaption" class="small text-center"></div>

                <!-- Prev / Next -->
                <button type="button" class="lb-nav btn opacity-75" id="prevPhoto" aria-label="Previous">‹</button>
                <button type="button" class="lb-nav btn opacity-75" id="nextPhoto" aria-label="Next">›</button>
              </div>
            </div>
          </div>
        </div>


          <!-- Tech Support Modal -->
          <div class="modal fade" id="techModal" tabindex="-1" aria-labelledby="techModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="techModalLabel">Tech Support - {{ room.building.name }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  {% if room.building.tech_contact_name %}
                    <p><strong>Contact:</strong> {{ room.building.tech_contact_name }}</p>
                  {% endif %}
                  {% if room.building.tech_contact%}
                    <p><strong>Phone:</strong> <a href="tel:{{ room.building.tech_contact }}">{{ room.building.tech_contact}}</a></p>
                  {% endif %}
                  {% if room.building.tech_contact_email %}
                    <p><strong>Email:</strong> <a href="mailto:{{ room.building.tech_contact_email }}">{{ room.building.tech_contact_email }}</a></p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

      
    </section>
  </div>
</div>
{% endblock %}
{% block body_end %}
<script src="https://unpkg.com/pannellum@2.5.6/build/pannellum.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const list = Array.from(document.querySelectorAll('.sidebar-thumbs a[href]'));
  if (!list.length) return;

  const modalEl = document.getElementById('photoLightbox');
  const modal = new bootstrap.Modal(modalEl, { focus: true });
  const imgEl = document.getElementById('lightboxImg');
  const capEl = document.getElementById('lightboxCaption');
  const prevBtn = document.getElementById('prevPhoto');
  const nextBtn = document.getElementById('nextPhoto');

  // Build an array of {url, caption}
  const photos = list.map(a => ({
    url: a.getAttribute('href'),
    caption: (a.querySelector('img')?.getAttribute('alt') || '').trim()
  }));

  let idx = 0;

  function show(i){
    if (i < 0) i = photos.length - 1;
    if (i >= photos.length) i = 0;
    idx = i;
    imgEl.src = photos[idx].url;
    imgEl.alt = photos[idx].caption || 'Classroom photo';
    capEl.textContent = photos[idx].caption || '';
    modal.show();
  }

  // Click any thumb -> open modal there
  list.forEach((a, i) => {
    a.addEventListener('click', e => {
      e.preventDefault();
      show(i);
    });
  });

  // Prev/Next buttons
  prevBtn.addEventListener('click', () => show(idx - 1));
  nextBtn.addEventListener('click', () => show(idx + 1));

  // Keyboard nav when modal is open
  modalEl.addEventListener('shown.bs.modal', () => {
    function onKey(e){
      if (e.key === 'ArrowLeft') { e.preventDefault(); show(idx - 1); }
      else if (e.key === 'ArrowRight') { e.preventDefault(); show(idx + 1); }
    }
    document.addEventListener('keydown', onKey);
    modalEl.addEventListener('hidden.bs.modal', () => document.removeEventListener('keydown', onKey), { once: true });
  });
});
</script>

<script>
(function () {
  function init() {
    if (!window.pannellum) return setTimeout(init, 40);

    const panoEl = document.getElementById('pano');
    if (!panoEl) return;

    // Make sure the viewer has height even if aspect-ratio flakes out
    if (!panoEl.clientHeight) {
      panoEl.style.minHeight = '320px';
      panoEl.style.height = 'min(60vh, 520px)';
    }

    // Build scenes from context, skip rows without a file
    const scenes = {};
    {% for p in panos %}
    {% if p.image_file %}
    scenes["p{{p.id}}"] = {
      type: "equirectangular",
      panorama: "{{ p.image_file.url|escapejs }}",
      {% if p.preview_file %}preview: "{{ p.preview_file.url|escapejs }}",{% endif %}
      yaw: {{ p.yaw|default:0 }},
      pitch: {{ p.pitch|default:0 }},
      hfov: {{ p.hfov|default:95 }},
      crossOrigin: "anonymous",
      autoLoad: true
    };
    {% endif %}
    {% endfor %}
    const ids = Object.keys(scenes);
    if (!ids.length) return;

    const viewer = pannellum.viewer('pano', {
      default: { firstScene: ids[0], sceneFadeDuration: 400, autoLoad: true },
      scenes: scenes,
      showControls: true
    });

    // Show pannellum errors instead of silent failure
    viewer.on('error', function (msg) {
      console.error('Pannellum error:', msg);
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
{% endblock %}
