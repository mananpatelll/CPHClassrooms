<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/pannellum/build/pannellum.css">
  <title>{{ room.building }} {{ room.room_number }}</title>
  <style>
    /* Layout & polish to match your screenshot */
    .sidebar-thumbs { position: sticky; top: 80px; }    /* sticks under navbar */
    .sidebar-thumbs img{ width:100%; height:110px; object-fit:cover;
                         border-radius:6px; border:1px solid #ddd; cursor:pointer; }
    .sidebar-thumbs img.active{ outline:3px solid #0d6efd }

    #pano-wrap{ position:relative; width:100%; border:1px solid #ddd; border-radius:8px; overflow:hidden; }
    /* wide panorama feel (3:1); bump to 42% if you want taller */
    #pano-wrap::before{ content:""; display:block; padding-top:33%; }
    #pano{ position:absolute; inset:0; }

    .features-card { border:1px solid #e5e7eb; border-radius:5px; overflow:hidden; margin-top:8px; }
    .features-header { background:#f8f9fa; padding:.50rem 1rem; font-weight:700; font-size:1.1rem; }
    .features-table { font-size:.75rem; margin:0; }
    .features-table th{ width:28%; color:#495057; }
    .features-table td, .features-table th { padding:.5rem .50rem; }
    .features-footer { background:#fff; padding:.50rem 1rem; border-top:1px solid #e5e7eb; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-md bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">CPH Classrooms</a>
  </div>
</nav>

<div class="container my-4">
  <h1 class="h4 text-center mb-3">{{ room.building }} {{ room.room_number }}</h1>

  <div class="row g-3">
    <!-- Left: vertical thumbnails -->
    <aside class="col-12 col-lg-3 order-2 order-lg-1">
      <div class="sidebar-thumbs vstack gap-3">
        {% for p in room.panoramas.all %}
        <img
          src="{{ p.preview_url|default:p.image_url }}"
          data-scene="p{{p.id}}"
          alt="{% if p.name %}{{ p.name }}{% else %}View {{ forloop.counter }}{% endif %}  of {{ room.building }} {{ room.room_number }}"
          class="{% if forloop.first %}active{% endif %}"
          loading="lazy" decoding="async">
        {% endfor %}
      </div>
    </aside>

    <!-- Right: pano viewer -->
    <section class="col-12 col-lg-9 order-1 order-lg-2">
      <div id="pano-wrap" role="region" aria-label="360-degree view of {{ room.building }} {{ room.room_number }}">
        <div id="pano"></div>
      </div>

      <!-- Features & Capabilities -->
      <div class="features-card">
        <div class="features-header">Features and Capabilities</div>
        <div class="table-responsive">
          <table class="table table-striped table-sm features-table">
            <tbody>
              {% if room.attributes.items %}
                {% for k, v in room.attributes.items %}
                  <tr><th>{{ k }}:</th><td>{{ v }}</td></tr>
                {% endfor %}
              {% elif room.attributes %}
                {% for item in room.attributes %}
                  <tr><th>{{ item.label }}:</th><td>{{ item.value }}</td></tr>
                {% endfor %}
              {% else %}
                <tr><td class="text-muted">No features provided.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="features-footer">
          <div class="d-flex flex-wrap gap-2 justify-content-end">
            <!-- Placeholder external links -->
            <a class="btn btn-primary" href="https://example.com/book" target="_blank" rel="noopener">Book this class</a>
            <a class="btn btn-outline-secondary" href="https://example.com/tech-support" target="_blank" rel="noopener">Tech support</a>
            <a class="btn btn-outline-dark" href="https://example.com/more-info" target="_blank" rel="noopener">More info</a>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://unpkg.com/pannellum/build/pannellum.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Build scenes from DB
  const scenes = {
  {% for p in room.panoramas.all %}
    "p{{p.id}}": {
      type: "equirectangular",
      panorama: "{{ p.image_url|escapejs }}",
      {% if p.preview_url %} preview: "{{ p.preview_url|escapejs }}",{% endif %}
      yaw: {{ p.yaw|default:0 }}, pitch: {{ p.pitch|default:0 }}, hfov: {{ p.hfov|default:95 }},
      autoLoad: true,
      hotSpots: [
        {% for h in p.hotspots.all %}
        { pitch: {{ h.pitch }}, yaw: {{ h.yaw }}, text: "{{ h.text|escapejs }}"{% if h.target_id %}, type:"scene", sceneId:"p{{ h.target_id }}"{% endif %} },
        {% endfor %}
      ]
    },
  {% endfor %}
  };
  const first = Object.keys(scenes)[0];
  if (!first) return;

  const viewer = pannellum.viewer('pano', {
    default: { firstScene: first, sceneFadeDuration: 500 },
    scenes,
    showControls: true
  });

  // Thumbnail â†’ switch scene + highlight
  const thumbs = document.querySelectorAll('.sidebar-thumbs img');
  thumbs.forEach(img => {
    img.addEventListener('click', () => {
      const scene = img.dataset.scene;
      if (scene) viewer.loadScene(scene);
      thumbs.forEach(x => x.classList.remove('active'));
      img.classList.add('active');
    });
  });
});
</script>
</body>
</html>
